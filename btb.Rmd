---
title: "BTB"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,message = F)
```

```{r load_packages}
library("lubridate", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("tidyverse", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
library("knitr", lib.loc="/Library/Frameworks/R.framework/Versions/3.4/Resources/library")
```

```{r}
nF<-function(x) {ifelse(is.na(x), F,x)}
countN<-function(x) {as.integer(sum(!is.na(x)))}
rmean<-function(x){mean(x,na.rm=T)}
rmeanr<-function(x){round(mean(x,na.rm=T),2)}
rmedian<-function(x){median(x,na.rm=T)}
rsum<-function(x) {sum(x,na.rm=T)}
```


```{r load_data}
load(file = "/Users/srhrnkn/Documents/authors/btb.Rdata")
```


```{r create_objects}
#summarize by interviewee: counts by gender, percents, bday, age
byint<-btb %>% group_by(interviewee.GRname,interviewee.id, interviewee.gender.use,interviewee.birthdate,Date) %>% summarise(countF=rsum(author.gender.use=="f"),countM=rsum(author.gender.use=="m"),countauth=countN(author.gender.use=="f")) %>% mutate(percF=countF/countauth,age=as.period(interval(interviewee.birthdate,Sys.Date()))$year) %>% mutate(varf=(1-percF)/countauth) %>% arrange(percF)


#summarize by author: mentiongs, bday, age
byauth<-btb %>% group_by(author.GRname, author.gender.use,author.birthdate) %>% summarise(countFint=rsum(interviewee.gender.use=="f"),countMint=rsum(interviewee.gender.use=="m"),countment=countN(interviewee.gender.use)) %>% mutate(percF=countFint/countment,age=as.period(interval(author.birthdate,Sys.Date()))$year) %>% arrange(desc(countment))

#authors with more than three mentions by date of interview
highfreqauthbydate<-btb %>%  filter(author.GRname %in% byauth$author.GRname[byauth$countment>3]) %>% select(author.GRname, interviewee.GRname, Date, interviewee.gender.use) %>% left_join(byauth[,c("author.GRname","countment")]) %>% arrange(desc(countment),author.GRname,Date) %>% mutate(author=factor(author.GRname,levels = rev(unique(author.GRname))))

#colors for plots
plotcolors<-data.frame(abbr=c("f","m"),adj=c("female","male"),noun=c("women","men"),color=c("#6e7684","#4661a0"),stringsAsFactors = F)

```


New York Times By The Book interviews  
`r paste0(as.character(month(min(byint$Date),label =  T,abbr = F))," ",day(min(byint$Date)),", ",year(min(byint$Date))," - ",as.character(month(max(byint$Date),label =  T,abbr = F))," ",day(max(byint$Date)),", ",year(max(byint$Date)))`

Total interviews: **`r nrow(byint)`**  
Total unique authors mentioned: **`r nrow(byauth)`**  
  
This data comes from the New York Times Book Review's "By the Book" feature - a weekly interview with a  literary figure in which the subject is asked a series of questions about their reading habits, past, present, and planned. The interviews yield a number of author and book recommendations - an average of **`r round(nrow(btb)/nrow(byint),)`** authors mentioned by name in each interview. This dataset is a result of some code that looks at the text of each interview, identifies strings of text that look like author names, verifies them by looking for corresponding names in the Goodreads author database. The gender information comes from the data in the Goodreads database, with missing data filled in manually.
  
  
It's not a huge surprise that women are more likely to mention authors who are women and men are more likely to mention men. The ratios are striking: men are four times more likely to recommend authors of their own gender, whereas women only just make it past a 1:1 ratio.

```{r }
#new
btb %>% group_by(interviewee.gender.use) %>% count(author.gender.use) %>% mutate(grcount=sum(n),perc=n/grcount,percformat=paste0(100*round(perc,2),'%')) %>% ggplot(aes(x=interviewee.gender.use,y=n,fill=author.gender.use)) + 
  geom_bar(stat = "identity",position = "fill") + geom_text(aes(label=paste0(percformat,"\n(",n,")")), position=position_fill(vjust=.5))+
  scale_fill_manual(values = plotcolors$color,name="Authors mentioned: ",labels=plotcolors$noun,guide=guide_legend(reverse = T))  + scale_x_discrete(labels=paste0(plotcolors$adj," interviewees (",c(sum(byint$interviewee.gender.use=="f"), sum(byint$interviewee.gender.use=="m")),")")) + 
  theme(axis.title=element_blank(),axis.text.x = element_blank(),axis.ticks.x = element_blank(),axis.ticks.y = element_blank(),panel.background = element_rect(fill = NA),legend.direction = "horizontal",legend.position = "top",legend.justification = c(0, 0)) + 
  coord_flip() +
  theme(aspect.ratio = .3)



```

The chart below shows each interviewee and the number of authors they mentioned, plotting the authors  by gender.  

```{r}
ggplot(byint %>% mutate(intervieweelevels=factor(interviewee.GRname,levels=byint$interviewee.GRname[order(byint$countauth)])),  aes(x = intervieweelevels)) +
         geom_bar(aes(y=byint$countF),stat = "identity",fill=plotcolors$color[1]) +
         geom_bar(aes(y=-1*byint$countM),stat = "identity",fill=plotcolors$color[2]) +
  xlab("Interviewees") + ylab("Author mentions") +
  scale_x_discrete(labels=paste(byint$interviewee.GRname[order(byint$countauth)],byint$countauth[order(byint$countauth)])) +
  scale_y_continuous(breaks = seq(-40, 40, 20),
                     labels = as.character(abs(seq(-40, 40, 20)))) +
  coord_flip()
```

This data has a long tail - there are **`r nrow(byauth)`** unique authors mentioned across the **`r nrow(byint)`** interviews, and **`r byauth %>% filter(countment==1) %>% nrow()`** of them are only mentioned once. The most frequently mentioned authors are mentioned by a fifth of all interviewees. The chart below shows the twenty most frequently mentioned authors, the number of times they were mentioned, and the dates they were mentioned. A longer time horizon might help us start to see patterns of trendy authors.

```{r}
#higher frequency by date mentioned
ggplot(highfreqauthbydate,aes(x=Date,y=author)) + 
  geom_point(aes(color=interviewee.gender.use)) + 
  theme(legend.position="none",axis.title=element_blank(),axis.ticks = element_blank(),plot.title = element_text()) + 
  scale_y_discrete(labels=rev(unique(paste0(highfreqauthbydate$author," (",highfreqauthbydate$countment,")")))) +  
  scale_x_date(date_minor_breaks = "1 month") +
  scale_color_manual(values=plotcolors$color) 
```


